# é«˜çº§åˆ†å—ç­–ç•¥æ–‡æ¡£

## æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº† 4 ç§é«˜çº§æ–‡æ¡£åˆ†å—ç­–ç•¥ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„å›ºå®šé•¿åº¦åˆ†å—ï¼Œè¿™äº›ç­–ç•¥èƒ½æ›´å¥½åœ°ä¿æŒè¯­ä¹‰å®Œæ•´æ€§å’Œä¸Šä¸‹æ–‡è¿è´¯æ€§ï¼Œæ˜¾è‘—æå‡ RAG ç³»ç»Ÿçš„æ£€ç´¢å’Œå›ç­”è´¨é‡ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦é«˜çº§åˆ†å—ï¼Ÿ

ä¼ ç»Ÿçš„ `RecursiveCharacterTextSplitter` å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

âŒ **è¯­ä¹‰å‰²è£‚**ï¼šå¯èƒ½åœ¨å¥å­ä¸­é—´åˆ‡æ–­ï¼Œç ´åè¯­ä¹‰å®Œæ•´æ€§  
âŒ **ä¸Šä¸‹æ–‡ä¸¢å¤±**ï¼šå›ºå®šé‡å å¯èƒ½æ— æ³•æ•è·å…³é”®ä¸Šä¸‹æ–‡  
âŒ **ç»“æ„å¿½ç•¥**ï¼šä¸è€ƒè™‘æ–‡æ¡£çš„å±‚æ¬¡ç»“æ„ï¼ˆæ ‡é¢˜ã€æ®µè½ç­‰ï¼‰  
âŒ **æ£€ç´¢æ•ˆæœå·®**ï¼šåˆ‡åˆ†ä¸å½“å¯¼è‡´ç›¸å…³å†…å®¹åˆ†æ•£åœ¨å¤šä¸ªå—ä¸­

## å››ç§é«˜çº§åˆ†å—ç­–ç•¥

### 1. è¯­ä¹‰åˆ†å— (Semantic Chunking)

**åŸç†**ï¼šåŸºäºæ®µè½å’Œå¥å­è¾¹ç•Œè¿›è¡Œæ™ºèƒ½åˆ†å—ï¼Œä¿æŒå†…å®¹çš„è¯­ä¹‰å®Œæ•´æ€§ã€‚

**ç‰¹ç‚¹**ï¼š
- âœ… å°Šé‡è‡ªç„¶æ®µè½è¾¹ç•Œï¼ˆåŒæ¢è¡Œç¬¦ï¼‰
- âœ… åœ¨å¥å­è¾¹ç•Œå¤„åˆ‡åˆ†ï¼Œé¿å…è¯­ä¹‰å‰²è£‚
- âœ… åŠ¨æ€è°ƒæ•´å—å¤§å°ï¼Œç¡®ä¿è¯­ä¹‰å•å…ƒå®Œæ•´
- âœ… é€‚åˆç»“æ„åŒ–æ–‡æ¡£ï¼ˆå¦‚æŠ€æœ¯æ–‡æ¡£ã€æ³•å¾‹æ–‡ä»¶ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- æŠ€æœ¯æ–‡æ¡£ã€API æ–‡æ¡£
- æ³•å¾‹åˆåŒã€æ”¿ç­–æ–‡ä»¶
- å­¦æœ¯è®ºæ–‡ã€ç ”ç©¶æŠ¥å‘Š

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
import { ChunkerFactory } from './utils/document-loader/AdvancedChunker';

const chunker = ChunkerFactory.create('semantic');
const chunks = await chunker.chunk(documents);
```

**å‚æ•°é…ç½®**ï¼š
```typescript
new SemanticChunker(
  maxChunkSize: 1000,  // æœ€å¤§å—å¤§å°
  minChunkSize: 200    // æœ€å°å—å¤§å°
)
```

---

### 2. æ»‘åŠ¨çª—å£åˆ†å— (Sliding Window Chunking)

**åŸç†**ï¼šä½¿ç”¨é‡å çš„æ»‘åŠ¨çª—å£ç¡®ä¿ä¸Šä¸‹æ–‡çš„è¿ç»­æ€§ï¼Œç±»ä¼¼äºå·ç§¯ç¥ç»ç½‘ç»œçš„æ»‘åŠ¨çª—å£ã€‚

**ç‰¹ç‚¹**ï¼š
- âœ… å›ºå®šçª—å£å¤§å°ï¼Œå¯é¢„æµ‹çš„å—é•¿åº¦
- âœ… å¯é…ç½®çš„é‡å åŒºåŸŸï¼Œç¡®ä¿ä¸Šä¸‹æ–‡è¿ç»­
- âœ… åœ¨å¥å­è¾¹ç•Œæ™ºèƒ½è°ƒæ•´çª—å£ç»“æŸä½ç½®
- âœ… é€‚åˆéœ€è¦å¼ºä¸Šä¸‹æ–‡ä¾èµ–çš„åœºæ™¯

**é€‚ç”¨åœºæ™¯**ï¼š
- å°è¯´ã€æ•…äº‹ç±»æ–‡æœ¬
- å¯¹è¯è®°å½•ã€èŠå¤©æ—¥å¿—
- éœ€è¦å‰åæ–‡å…³è”çš„å†…å®¹

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
const chunker = ChunkerFactory.create('sliding');
const chunks = await chunker.chunk(documents);
```

**å‚æ•°é…ç½®**ï¼š
```typescript
new SlidingWindowChunker(
  windowSize: 1000,  // çª—å£å¤§å°
  stepSize: 800      // æ­¥é•¿ï¼ˆçª—å£ç§»åŠ¨è·ç¦»ï¼‰
)
// é‡å åŒºåŸŸ = windowSize - stepSize = 200 å­—ç¬¦
```

**å¯è§†åŒ–ç¤ºä¾‹**ï¼š
```
æ–‡æ¡£: [AAAAAABBBBBBCCCCCCDDDDDD]
      
çª—å£1: [AAAAAABBBBBB]
çª—å£2:       [BBBBBBCCCCCC]  â† é‡å éƒ¨åˆ† BB
çª—å£3:             [CCCCCCDDDDDD]  â† é‡å éƒ¨åˆ† CC
```

---

### 3. å±‚æ¬¡åŒ–åˆ†å— (Hierarchical Chunking)

**åŸç†**ï¼šåˆ›å»ºå¤šå±‚æ¬¡çš„æ–‡æ¡£å—ï¼ŒåŒ…å«çˆ¶å­å…³ç³»ï¼Œä¿ç•™æ–‡æ¡£çš„å±‚æ¬¡ç»“æ„ã€‚

**ç‰¹ç‚¹**ï¼š
- âœ… çˆ¶å—æä¾›å®è§‚ä¸Šä¸‹æ–‡ï¼ˆ2000 å­—ç¬¦ï¼‰
- âœ… å­å—æä¾›ç»†èŠ‚ä¿¡æ¯ï¼ˆ500 å­—ç¬¦ï¼‰
- âœ… ä¿ç•™çˆ¶å­å…³ç³»å…ƒæ•°æ®
- âœ… æ£€ç´¢æ—¶å¯ä»¥åŒæ—¶åˆ©ç”¨ç²—ç²’åº¦å’Œç»†ç²’åº¦ä¿¡æ¯

**é€‚ç”¨åœºæ™¯**ï¼š
- é•¿ç¯‡æŠ€æœ¯æ–‡æ¡£
- æ•™ç§‘ä¹¦ã€åŸ¹è®­ææ–™
- éœ€è¦å¤šå±‚æ¬¡ç†è§£çš„å¤æ‚å†…å®¹

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
const chunker = ChunkerFactory.create('hierarchical');
const chunks = await chunker.chunk(documents);

// æ¯ä¸ªå­å—åŒ…å«çˆ¶å—ä¿¡æ¯
console.log(chunks[0].metadata);
// {
//   parentId: 'parent_0',
//   parentText: 'çˆ¶å—æ‘˜è¦...',
//   childIndex: 0,
//   totalChildren: 4
// }
```

**å‚æ•°é…ç½®**ï¼š
```typescript
new HierarchicalChunker(
  parentSize: 2000,  // çˆ¶å—å¤§å°
  childSize: 500,    // å­å—å¤§å°
  overlap: 100       // é‡å åŒºåŸŸ
)
```

**å±‚æ¬¡ç»“æ„ç¤ºä¾‹**ï¼š
```
æ–‡æ¡£
â”œâ”€â”€ çˆ¶å— 1 (2000 å­—ç¬¦)
â”‚   â”œâ”€â”€ å­å— 1.1 (500 å­—ç¬¦)
â”‚   â”œâ”€â”€ å­å— 1.2 (500 å­—ç¬¦)
â”‚   â””â”€â”€ å­å— 1.3 (500 å­—ç¬¦)
â”œâ”€â”€ çˆ¶å— 2 (2000 å­—ç¬¦)
â”‚   â”œâ”€â”€ å­å— 2.1 (500 å­—ç¬¦)
â”‚   â””â”€â”€ å­å— 2.2 (500 å­—ç¬¦)
```

---

### 4. æ™ºèƒ½åˆ†å— (Smart Chunking) â­ æ¨è

**åŸç†**ï¼šè‡ªåŠ¨æ£€æµ‹æ–‡æ¡£ç±»å‹å’Œç»“æ„ï¼Œé€‰æ‹©æœ€ä½³åˆ†å—ç­–ç•¥ã€‚

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨æ£€æµ‹æ–‡æ¡£ç»“æ„ï¼ˆæ ‡é¢˜ã€ç« èŠ‚ç­‰ï¼‰
- âœ… ç»“æ„åŒ–æ–‡æ¡£æŒ‰æ ‡é¢˜å’Œæ®µè½åˆ†å—
- âœ… éç»“æ„åŒ–æ–‡æ¡£ä½¿ç”¨è¯­ä¹‰åˆ†å—
- âœ… ç»¼åˆå¤šç§ç­–ç•¥çš„ä¼˜ç‚¹
- âœ… **é»˜è®¤æ¨èä½¿ç”¨**

**é€‚ç”¨åœºæ™¯**ï¼š
- æ··åˆç±»å‹æ–‡æ¡£
- ä¸ç¡®å®šæ–‡æ¡£ç»“æ„æ—¶
- éœ€è¦é€šç”¨è§£å†³æ–¹æ¡ˆæ—¶

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
const chunker = ChunkerFactory.create('smart'); // é»˜è®¤ç­–ç•¥
const chunks = await chunker.chunk(documents);
```

**å‚æ•°é…ç½®**ï¼š
```typescript
new SmartChunker(
  targetSize: 800,   // ç›®æ ‡å—å¤§å°
  maxSize: 1200,     // æœ€å¤§å—å¤§å°
  minSize: 300       // æœ€å°å—å¤§å°
)
```

**æ™ºèƒ½æ£€æµ‹é€»è¾‘**ï¼š
```typescript
// æ£€æµ‹æ–‡æ¡£æ˜¯å¦æœ‰ç»“æ„
const hasStructure = detectStructure(text);

if (hasStructure) {
  // æŒ‰æ ‡é¢˜å’Œæ®µè½åˆ†å—
  chunkStructuredText();
} else {
  // ä½¿ç”¨è¯­ä¹‰åˆ†å—
  semanticChunking();
}
```

---

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1ï¼šåœ¨ä»£ç ä¸­æŒ‡å®šç­–ç•¥

```typescript
import { initializeRagSystem } from './agents/ragAgent';

// ä½¿ç”¨æ™ºèƒ½åˆ†å—ï¼ˆæ¨èï¼‰
await initializeRagSystem('./tests/', 'smart');

// ä½¿ç”¨è¯­ä¹‰åˆ†å—
await initializeRagSystem('./tests/', 'semantic');

// ä½¿ç”¨æ»‘åŠ¨çª—å£
await initializeRagSystem('./tests/', 'sliding');

// ä½¿ç”¨å±‚æ¬¡åŒ–åˆ†å—
await initializeRagSystem('./tests/', 'hierarchical');
```

### æ–¹æ³• 2ï¼šé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®ï¼š
```bash
CHUNKING_STRATEGY=smart
```

ç„¶åæ­£å¸¸å¯åŠ¨æœåŠ¡ï¼š
```bash
npm start
```

### æ–¹æ³• 3ï¼šå¯¹æ¯”æµ‹è¯•æ‰€æœ‰ç­–ç•¥

è¿è¡Œå¯¹æ¯”è„šæœ¬æŸ¥çœ‹å„ç­–ç•¥çš„æ•ˆæœï¼š
```bash
npx tsx scripts/compareChunkingStrategies.ts
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸ“Š åˆ†å—ç­–ç•¥å¯¹æ¯”æµ‹è¯•
================================================================================

ğŸ“„ æ–‡æ¡£ä¿¡æ¯:
  - æ–‡æ¡£æ•°é‡: 1
  - æ€»å­—ç¬¦æ•°: 45,230
  - å¹³å‡æ–‡æ¡£é•¿åº¦: 45,230 å­—ç¬¦

================================================================================

ğŸ” æµ‹è¯•ç­–ç•¥: SEMANTIC

ç­–ç•¥åç§°: Semantic Chunking
ç­–ç•¥æè¿°: åŸºäºæ®µè½å’Œå¥å­è¾¹ç•Œçš„è¯­ä¹‰åˆ†å—ï¼Œä¿æŒå†…å®¹å®Œæ•´æ€§

ğŸ“ˆ ç»Ÿè®¡ç»“æœ:
  - æ€»å—æ•°: 52
  - å¹³å‡é•¿åº¦: 870 å­—ç¬¦
  - æœ€å°é•¿åº¦: 245 å­—ç¬¦
  - æœ€å¤§é•¿åº¦: 1,198 å­—ç¬¦
  - æ ‡å‡†å·®: 215 å­—ç¬¦
  - å¤„ç†æ—¶é—´: 45ms
  - å‹ç¼©æ¯”: 870.2:1

================================================================================

ğŸ“Š ç­–ç•¥å¯¹æ¯”æ€»ç»“

ç­–ç•¥åç§°                        å—æ•°        å¹³å‡é•¿åº¦      æ ‡å‡†å·®      è€—æ—¶
--------------------------------------------------------------------------------
Semantic Chunking             52        870         215       45ms
Sliding Window Chunking       57        794         156       38ms
Hierarchical Chunking         180       251         98        62ms
Smart Chunking                48        942         198       52ms

================================================================================

ğŸ’¡ æ¨èå»ºè®®:

  âœ“ æœ€ä¸€è‡´çš„åˆ†å—: Hierarchical Chunking (æ ‡å‡†å·®: 98)
  âœ“ æœ€å¿«çš„å¤„ç†: Sliding Window Chunking (38ms)
  âœ“ æœ€ç»†ç²’åº¦: Hierarchical Chunking (180 å—)

  æ¨èä½¿ç”¨: Smart Chunking (æ™ºèƒ½åˆ†å—) - ç»¼åˆæ€§èƒ½æœ€ä½³
```

---

## æ€§èƒ½å¯¹æ¯”

| ç­–ç•¥ | å—æ•° | å¹³å‡é•¿åº¦ | æ ‡å‡†å·® | è¯­ä¹‰å®Œæ•´æ€§ | ä¸Šä¸‹æ–‡ä¿ç•™ | å¤„ç†é€Ÿåº¦ |
|------|------|----------|--------|------------|------------|----------|
| Semantic | â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| Sliding Window | â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| Hierarchical | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| Smart | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |

---

## æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„ç­–ç•¥

```typescript
// æŠ€æœ¯æ–‡æ¡£ã€API æ–‡æ¡£
const chunker = ChunkerFactory.create('semantic');

// å°è¯´ã€æ•…äº‹
const chunker = ChunkerFactory.create('sliding');

// æ•™ç§‘ä¹¦ã€é•¿ç¯‡æ–‡æ¡£
const chunker = ChunkerFactory.create('hierarchical');

// ä¸ç¡®å®šæ—¶ï¼ˆæ¨èï¼‰
const chunker = ChunkerFactory.create('smart');
```

### 2. è°ƒæ•´å‚æ•°

æ ¹æ®æ–‡æ¡£ç‰¹ç‚¹è°ƒæ•´å‚æ•°ï¼š

```typescript
// çŸ­æ–‡æ¡£ï¼ˆå¦‚æ–°é—»ã€åšå®¢ï¼‰
new SmartChunker(500, 800, 200);

// ä¸­ç­‰æ–‡æ¡£ï¼ˆå¦‚æŠ€æœ¯æ–‡æ¡£ï¼‰
new SmartChunker(800, 1200, 300);  // é»˜è®¤

// é•¿æ–‡æ¡£ï¼ˆå¦‚ä¹¦ç±ã€è®ºæ–‡ï¼‰
new SmartChunker(1200, 1800, 400);
```

### 3. ç›‘æ§åˆ†å—è´¨é‡

```typescript
const chunks = await chunker.chunk(documents);

// æ£€æŸ¥å—çš„å…ƒæ•°æ®
chunks.forEach(chunk => {
  console.log({
    length: chunk.pageContent.length,
    strategy: chunk.metadata.chunkingStrategy,
    index: chunk.metadata.chunkIndex
  });
});
```

---

## æŠ€æœ¯äº®ç‚¹ï¼ˆé¢è¯•/å±•ç¤ºç”¨ï¼‰

1. **è¯­ä¹‰å®Œæ•´æ€§ä¿è¯**ï¼šé€šè¿‡æ®µè½å’Œå¥å­è¾¹ç•Œæ£€æµ‹ï¼Œé¿å…è¯­ä¹‰å‰²è£‚
2. **è‡ªé€‚åº”ç­–ç•¥é€‰æ‹©**ï¼šæ™ºèƒ½æ£€æµ‹æ–‡æ¡£ç»“æ„ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³åˆ†å—æ–¹æ³•
3. **å±‚æ¬¡åŒ–ä¿¡æ¯ä¿ç•™**ï¼šçˆ¶å­å—å…³ç³»ä¿ç•™äº†æ–‡æ¡£çš„å¤šå±‚æ¬¡ç»“æ„
4. **ä¸Šä¸‹æ–‡è¿ç»­æ€§**ï¼šæ»‘åŠ¨çª—å£ç¡®ä¿ç›¸é‚»å—ä¹‹é—´çš„ä¿¡æ¯è¿è´¯
5. **å¯æ‰©å±•æ¶æ„**ï¼šç­–ç•¥æ¨¡å¼è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°çš„åˆ†å—ç®—æ³•

---

## è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

- [ ] åŸºäº Embedding çš„è¯­ä¹‰ç›¸ä¼¼åº¦åˆ†å—
- [ ] ä½¿ç”¨ LLM è¿›è¡Œæ™ºèƒ½åˆ†å—ï¼ˆæˆæœ¬è¾ƒé«˜ï¼‰
- [ ] æ”¯æŒå¤šè¯­è¨€åˆ†å—ä¼˜åŒ–
- [ ] åŠ¨æ€è°ƒæ•´å—å¤§å°ï¼ˆåŸºäºå†…å®¹å¯†åº¦ï¼‰
- [ ] åˆ†å—è´¨é‡è¯„ä¼°æŒ‡æ ‡

---

## å‚è€ƒèµ„æ–™

- [LangChain Text Splitters](https://js.langchain.com/docs/modules/data_connection/document_transformers/)
- [Chunking Strategies for LLM Applications](https://www.pinecone.io/learn/chunking-strategies/)
- [Advanced RAG Techniques](https://arxiv.org/abs/2312.10997)
